WITH fetchSpend AS(
SELECT
*
FROM (

(SELECT
      Created,
      AdName as AdNameTrafficking,
      TrackingLink,
      Product,
      Campaign,
      Vendor,
      Country,
      OperatingSystem,
      Device,
      Channel,
      CreativeType,
      Targeting,
      Creative,
      CreativeSize,
      CreativeConcept,
      CreativeLanguage,
      TrafficType,
      Tracking,
      Goal,
      MediaType,
      Placement,
      SocialString
FROM (
  SELECT
-- Select all fields
    *,
-- Select the most recent record uploaded to bigquery with unique date, adname & etc parameters
    MAX(ingestedDate) OVER (PARTITION BY AdName) AS maxIngestionDate
  FROM (
    SELECT
-- create column that adds the table suffix to query for aggregation
      _table_suffix AS ingestedDate,
      *
    FROM
      `ga-mozilla-org-prod-001.fetch.trafficking_*`
-- Group by all dimensions to get unique value combinations so as to be able to partition by ingested date
    GROUP BY 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23))
WHERE
  ingestedDate = maxIngestionDate) as trafficking

LEFT JOIN
-- Join metric / spend data to campaign information data
(SELECT
*
FROM(
SELECT
  *,
  MAX(ingestionDate) OVER (PARTITION BY date, Adname) AS IngestionDateMax
FROM (
  SELECT
    _table_suffix AS ingestionDate,
    *
  FROM
    `ga-mozilla-org-prod-001.fetch.metric_*`))
WHERE ingestionDate = IngestionDateMax) as metric

ON trafficking.adNameTrafficking = metric.Adname))

SELECT * FROM fetchSpend
WHERE date